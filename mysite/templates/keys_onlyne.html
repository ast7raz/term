{%extends "base.html" %}
{%block title%}Терминалы онлайн{%endblock%}
{%block content%}
<script src="/static/event.js"></script>



<section class=filter>


<div>
<form action="/rtc">
<label name=key>Ключ</label>
<input label="Ключ" type="text" name=key value="{{tizer.key}}">
<label name=name>Имя ключа</label>
<input type="text" name=name value="{{tizer.name}}">
<label name=part>Партнёрка</label>
<input type="text" name=part value="{{tizer.part}}">
<label name=club>Клуб</label>
<input type="text" name=club value="{{tizer.club}}">
<label name=admin>Логин админа</label>
<input type="text" name=admin value="{{tizer.adm}}">

<input type="submit" value="Фильтровать">
<button type="button" onclick="location.href='/rtc'" >Очистить</button>
</form>
</div>
</section>
{%if goll%}
<section class=head_div>
<table class=head_table>
	<caption>Ключи терминалов в колличестве: {{lenkey}}; Старых:{{old}}; Новых:{{new}};</caption>	
	<tr class="keysstring">
	
	<th class="keys">Ключ терминала</th>
	<th class="name">Имя ключа терминала</th>
	<th class="part">Партнёрка</th>
	<th class="club">Клуб</th>
	<th class="version">Версия образа терминала</th>
	<th class="ip">Ip терминала</th>
	<th class="ud">Удалёнка</th>
	<th class="active">Активация</th>
	<th class="blocked">Блокировка</th>
	
	</tr>
</table>	

</section>
<section class=head_div>
<table class=content>
	{%for key in goll%}

	<tr class="keysstring">
	<td class="keys">{{key.key}}</td>
	<td class="name">{{key.name}}</td>
	<td class="part">{{key.part}}</td>
	<td class="club">{{key.club}}</td>
	<td class="version">{{key.version}}</td>
	<td class="ip">{{key.ip}}</td>
	<td class="ud">
	{%if key.vnc %}
	{%if key.version != "1.0.8" and key.version != "1.0.7" and key.version != "1.0.6" and key.version != "0.0.2" and key.version != "1.0.4"%}
	<button class="but" title="Соединение через канал VNC" name="VNC" OnClick="vnc('VNC {{key.key}} {{key.vnc}}');">VNC</button>
	<button class="but" title="Соединение через канал SSH" name="VNC" OnClick="vnc('VNC {{key.key}} {{key.ssh}}');">SSH</button>
	{%else%}
	<button class="bu" title="Соединение через канал VNC" style="visibility:hidden;" name="VNC">VNC</button>
	<button class="bu" title="Соединение через канал SSH" style="visibility:hidden;" name="VNC">SSH</button>
	{%endif%}
	<button class="bu" title="Разрыв всех существующих содинений данного терминала, терминал не на долго пропадает со страници активных терминалов. Не влияет на работу терминала." name="X" OnClick="vnc('X {{key.key}} {{key.x}}');">X</button>
	{%if key.upgrade %}
	<button class="bu"name"upgrade" OnClick="vnc('upgrade {{key.key}} {{key.upgrade}}')">UP</button>
	{%endif%}
	{%else%}
	Upgrading
	{%endif%}
	</td>
	<td class="active">
	{% if key.active == True%}
	<img src="/static/galka.png" width="20" height="20" alt="{{key.active}}">
	{% else%}
	<img src="/static/Krest.png" width="20" height="20" alt="{{key.active}}">
	{% endif %}
	</td>
	<td class="blocked">
	{% if key.blocked == True%}
	<img src="/static/galka.png" width="20" height="20" alt="{{key.blocked}}">
	{% else%}
	<img src="/static/Krest.png" width="20" height="20" alt="{{key.blocked}}">
	{% endif %}
	</td>
	</tr>
	
	{%endfor%}
	</table>
<p id=calc>Всего ключей онлайн: {{lenkey}}. Известных: {{lenfi}}.</p>
</section>
{%else%}
<p>Ключей онлайн по вашему запросу не найдено</p>
{%endif%}
<p><a href="/static/setup.rar">Утилитка</a></p>
<script>
function sen(cmd){
// (1)
var XHR = ("onload" in new XMLHttpRequest()) ? XMLHttpRequest : XDomainRequest;

var xhr = new XHR();
if (cmd!="Connection"){
var body="con="+encodeURIComponent(cmd);
}else{
var body= "con="+encodeURIComponent("True");
}
// (2) запрос на другой домен :)
xhr.open('POST', 'http://localhost:52213/con', true);
xhr.setRequestHeader('Access-Control-Request-Headers', 'Origin, X-Requested-With');
xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
xhr.onload = function() {
  console.log( this.responseText );
}

xhr.onerror = function() {
  alert( 'Ошибка ' + this.status );
}

xhr.send(body);}


function vnc(key){
console.log(key)
key=key.split(" ")
console.log(key)

// (1)
//var XHR = new XMLHttpRequest();// ? XMLHttpRequest : XDomainRequest;

var xhr = new XMLHttpRequest();
var csrf="{% csrf_token %}";
var toc=csrf.split(" ")[3].split("=")[1].replace("'","").replace("'","");
var body= "fun="+encodeURIComponent(key[0])+"&key="+encodeURIComponent(key[1])+"&csrfmiddlewaretoken="+encodeURIComponent(toc)+"&page="+encodeURIComponent(key[2]);
console.log(body)

// (2) запрос на другой домен :)
xhr.open('POST', '/rtc/get_key/', true);
//xhr.setRequestHeader('Access-Control-Request-Headers', 'Origin, X-Requested-With');
xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
xhr.onload = function() {
	var cmd=this.responseText
	if (cmd=="DONE"){
		location.reload();
	}
	else{
	console.log(cmd)
	sen(cmd)}
}

xhr.onerror = function() {
  alert( 'Ошибка ' + this.status );
}

xhr.send(body);
}
function con(){

// (1)
var XHR = ("onload" in new XMLHttpRequest()) ? XMLHttpRequest : XDomainRequest;
var btn=document.getElementsByClassName('but');
var xhr = new XHR();
var body= "con="+encodeURIComponent("True");
// (2) запрос на другой домен :)
xhr.open('GET', 'http://localhost:52213/con', true);
//xhr.setRequestHeader('Access-Control-Request-Headers', 'Origin, X-Requested-With');
xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
xhr.onload = function() {
  //console.log( this.responseText );
	for (butn in btn){
		//console.log(butn)
		if (butn!="item" && butn!="namedItem" && butn!="length"){
		//console.log(btn[butn]);
		btn[butn].style.visibility="visible"
		}
		}
}

xhr.onerror = function() {
	for (butn in btn){
		//console.log(butn)
		if (butn!="item" || butn!="namedItem" || butn!="length"){
		//aconsole.log(btn[butn]);
		var ert=typeof(btn[butn])
		if (ert=="object"){
		//console.log(ert)
		btn[butn].style.visibility="hidden"}
		}
	}

	}

xhr.send();
//setInterval(con,10000)
}
con()
</script>

{%endblock%}